<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>M√≥dulo de Mantenimientos - CMMS</title>

    <style>
        /* ========================================================== */
        /* === 1. ESTILOS BASE === */
        /* ========================================================== */
        body {
            margin: 0;
            background: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        header {
            background: #1e293b;
            color: white;
            padding: 15px 30px;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ==================== CAMPANITA ==================== */
        .notif-btn {
            cursor: pointer;
            font-size: 22px;
            color: white;
            transition: 0.2s;
            text-decoration: none;
        }
        .notif-btn:hover {
            color: #facc15;
            transform: scale(1.1);
        }

        .container {
            padding: 25px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 22px;
            font-weight: bold;
            color: #1e293b;
        }

        .btn-volver {
            background: #475569;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }
        .btn-volver:hover {
            background: #334155;
        }

        /* ========================================================== */
        /* === 2. TARJETAS === */
        /* ========================================================== */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            margin: 0 0 10px 0;
            color: #334155;
            font-weight: bold;
        }

        .card p {
            color: #64748b;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .card button {
            padding: 8px 15px;
            border: none;
            background: #1d4ed8;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        .card button:hover {
            background: #1e40af;
        }

        /* ========================================================== */
        /* === 3. SECCI√ìN TABLA === */
        /* ========================================================== */
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.05);
        }

        .section h2 {
            margin-bottom: 15px;
            color: #1e293b;
            font-size: 20px;
        }

        .btn-imprimir {
            padding: 10px 15px;
            border-radius: 8px;
            background: #f59e0b;
            color: white;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-imprimir:hover {
            background: #d97706;
        }

        /* === Buscador === */
        .search-container {
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .search-container input {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            width: 300px;
            font-size: 14px;
        }

        /* === Tabla === */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #e2e8f0;
            padding: 10px;
            color: #1e293b;
            text-align: left;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            color: #334155;
        }

        tr:hover {
            background: #f8fafc;
        }

        /* === Barra de progreso === */
        .barra-externa {
            background: #e5e7eb;
            border-radius: 6px;
            height: 16px;
            width: 100%;
        }

        .barra-interna {
            background: #2563eb;
            color: white;
            height: 100%;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            transition: width .5s;
        }

        /* ==================== ACCIONES ==================== */
        .actions button {
            margin-right: 5px;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

.notif-btn {
    position: relative;
    font-size: 28px;
    text-decoration: none;
}

.notif-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: red;
    color: white;
    font-size: 12px;
    padding: 3px 6px;
    border-radius: 50%;
    font-weight: bold;
}


        .btn-ver { background: #475569; }
        .btn-ver:hover { background: #334155; }

        .btn-realizar { background: #16a34a; }
        .btn-realizar:hover { background: #15803d; }

        .btn-actividad { background: #1e40af; }
        .btn-actividad:hover { background: #1e3a8a; }

        .btn-cerrar { background: #d97706; }
        .btn-cerrar:hover { background: #b45309; }

        .btn-eliminar { background: #dc2626 !important; }
        .btn-eliminar:hover { background: #b91c1c !important; }

        /* === Prioridades === */
        .prio-Cr√≠tica { color:#dc2626; font-weight:bold; }
        .prio-Alta { color:#ea580c; font-weight:bold; }
        .prio-Media { color:#2563eb; font-weight:bold; }
        .prio-Baja { color:#16a34a; }

        .estado-pendiente { color:#d97706; font-weight:bold; }
        .estado-realizado { color:#059669; font-weight:bold; }
    </style>
</head>

<body>

<header>
    M√≥dulo de Mantenimientos ‚Äì CMMS

    <!-- üîî Campanita de notificaciones -->
    <a href="{{ url_for('solicitudes_repuestos_admin') }}" class="notif-btn">
        üîî
        {% if notif_pendientes > 0 %}
            <span class="notif-badge">{{ notif_pendientes }}</span>
        {% endif %}
    </a>

</header>

<div class="container">

    <!-- Encabezado -->
    <div class="header-content">
        <div class="title">Panel principal de mantenimiento</div>
        <a href="{{ url_for('inicio') }}" class="btn-volver">‚Üê Volver al inicio</a>
    </div>

    <!-- ============= TARJETAS ============= -->
    <div class="card-container">

        <div class="card">
            <h3>Planificador üóìÔ∏è</h3>
            <p>Planifica los mantenimientos diarios, mensuales y semestrales.</p>
            <button onclick="location.href='/ver_planes_mantenimiento'">Ir a Planificador</button>
        </div>

        <div class="card">
            <h3>Nueva Orden de Trabajo üìù</h3>
            <p>Genera una OT adicional manual.</p>
            <button onclick="location.href='/nueva_orden_trabajo'">Crear OT</button>
        </div>

        <div class="card">
            <h3>Historial üìä</h3>
            <p>Consulta trabajos realizados por m√°quina y t√©cnico.</p>
            <button onclick="location.href='/historial_mantenimiento'">Ver Historial</button>
        </div>

        <div class="card">
            <h3>Asignaci√≥n de T√©cnicos üë®‚Äçüîß</h3>
            <p>Crear, editar y asignar t√©cnicos.</p>
            <button onclick="location.href='/tecnicos'">Ver Asignaci√≥n</button>
        </div>

    </div>

    <!-- ============= TABLA OTs ============= -->
    <div class="section">
        <h2>üîß √ìrdenes de trabajo abiertas</h2>

        <a href="{{ url_for('imprimir_ots_masivo') }}"
           target="_blank" class="btn-imprimir">üñ®Ô∏è Imprimir Todas</a>

        <div class="search-container">
            <input type="text" id="buscadorEquipo" onkeyup="filtrarPorEquipo()" placeholder="Buscar por equipo...">
        </div>

        <div style="overflow-x:auto;">
            <table id="tablaOTs">
                <thead>
                    <tr>
                        <th>N¬∞ OT</th>
                        <th>Equipo</th>
                        <th>Tipo</th>
                        <th>Fecha inicio</th>
                        <th>Fecha final</th>
                        <th>Duraci√≥n (min)</th>
                        <th>Avance</th>
                        <th>T√©cnico</th>
                        <th>Prioridad</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for ot in ordenes %}

                    {% set clase_estado =
                        'estado-realizado' if ot.estado=='Finalizada'
                        else 'estado-pendiente'
                    %}

                    <tr class="fila-ot">
                        <td>{{ ot.numero_ot }}</td>
                        <td>{{ ot.equipo_nombre }}</td>
                        <td>{{ ot.tipo_mantenimiento }}</td>
                        <td>{{ ot.fecha_inicio }}</td>
                        <td>{{ ot.fecha_final }}</td>
                        <td>{{ ot.duracion_estimada_total }}</td>

                        <td>
                            <div class="barra-externa">
                                <div class="barra-interna" data-porcentaje="{{ ot.porcentaje }}">
                                    {{ ot.porcentaje }} %
                                </div>
                            </div>
                        </td>

                        <td>{{ ot.tecnico }}</td>
                        <td class="prio-{{ ot.prioridad }}">{{ ot.prioridad }}</td>
                        <td class="{{ clase_estado }}">{{ ot.estado }}</td>

                        <td class="actions">
                            <button class="btn-ver" onclick="toggleActividades('act-{{ ot.id }}')">üëÅÔ∏è Ver</button>
                            <button class="btn-realizar" onclick="location.href='/realizar_ot/{{ ot.id }}'">‚öôÔ∏è Realizar</button>
                            <button class="btn-actividad" onclick="location.href='/agregar_actividad/{{ ot.id }}'">‚ûï Actividad</button>
                            <button class="btn-cerrar"
                                onclick="return confirm('¬øSeguro que desea cerrar esta OT?') ? location.href='/finalizar_ot/{{ ot.id }}' : false;">
                                ‚úîÔ∏è Cerrar
                            </button>
                        </td>
                    </tr>

                    <!-- Fila actividades -->
                    <tr id="act-{{ ot.id }}" style="display:none;background:#fafafa;">
                        <td colspan="11">

                            <h4 style="margin:10px 0;color:#334155;">üìã Actividades de esta OT</h4>

                            <table>
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Descripci√≥n</th>
                                        <th>Prioridad</th>
                                        <th>D√≠as</th>
                                        <th>Duraci√≥n</th>
                                        <th>Tipo</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    {% for act in ot.actividades %}
                                    <tr>
                                        <td>{{ act.codigo_actividad }}</td>
                                        <td>{{ act.descripcion }}</td>
                                        <td>{{ act.prioridad }}</td>
                                        <td>{{ act.dias_mes }}</td>
                                        <td>{{ act.duracion_estimada }}</td>
                                        <td>{{ act.tipo_trabajo }}</td>
                                        <td class="actions">
                                            <button onclick="location.href='/editar_actividad/{{ act.id }}'">‚úèÔ∏è</button>
                                            <button class="btn-eliminar"
                                                onclick="return confirm('¬øEliminar actividad?') ? location.href='/eliminar_actividad/{{ act.id }}' : false;">
                                                üóëÔ∏è
                                            </button>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="7" style="text-align:center;color:#888;">No hay actividades para esta OT</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>

                            </table>

                        </td>
                    </tr>

                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    /* === Expandir actividades === */
    function toggleActividades(id){
        const fila = document.getElementById(id);
        fila.style.display = (fila.style.display === "none") ? "table-row" : "none";
    }

    /* === Buscar por equipo === */
    function filtrarPorEquipo() {
        const filtro = document.getElementById("buscadorEquipo").value.toUpperCase();
        const filas = document.querySelectorAll(".fila-ot");

        filas.forEach(f => {
            const equipo = f.children[1].innerText.toUpperCase();
            f.style.display = equipo.includes(filtro) ? "" : "none";
        });
    }

    /* === Barras de progreso animadas === */
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".barra-interna").forEach(barra => {
            barra.style.width = barra.dataset.porcentaje + "%";
        });
    });
</script>

</body>
</html>
