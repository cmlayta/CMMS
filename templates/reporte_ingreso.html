<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Ingreso de Repuestos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1, h2 {
            color: #2c3e50;
        }
        form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            background: #f9f9f9;
        }
        label {
            font-weight: bold;
            margin-right: 10px;
        }
        select[multiple] {
            height: 100px;
            width: 250px;
        }
        input[type="date"] {
            padding: 5px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
        }
        th, td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #27ae60;
            color: white;
        }
        .total-container {
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
            color: #2980b9;
        }
        .chart-container {
            width: 70%;
            margin: 30px auto;
        }
        button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            margin-right: 10px;
            border-radius: 4px;
            font-size: 15px;
        }
        button:hover {
            background-color: #1f7e4d;
        }
        a {
            margin-left: 10px;
        }
        .boton-volver {
            background-color: #7f8c8d;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 16px;
            margin-left: 10px;
        }
        .boton-volver:hover {
            background-color: #5d6d7e;
        }

    </style>
</head>
<body>

    <h1>Reporte de Ingreso de Repuestos</h1>

    <form method="post" action="{{ url_for('reporte_ingreso') }}">
          <label>Equipos:</label><br>
  <input type="text" id="buscar_equipo" placeholder="Buscar equipo..." 
         style="padding:5px; width:250px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px;"><br>
  <div id="lista_equipos" 
       style="border:1px solid #ccc; background:#fff; padding:8px; width:260px; height:150px; overflow-y:auto;">
      
      <label style="display:block; margin-bottom:4px;">
        <input type="checkbox" name="equipos" value="todos"
               {% if 'todos' in filtros.equipos %}checked{% endif %}> -- Todos los equipos --
      </label>

      {% for equipo in equipos_lista %}
      <label style="display:block; margin-bottom:4px;">
        <input type="checkbox" name="equipos" value="{{ equipo }}"
               {% if equipo in filtros.equipos %}checked{% endif %}> {{ equipo }}
      </label>
      {% endfor %}
  </div>
  <button type="button" id="deseleccionar_todo" style="margin-bottom:10px;">Deseleccionar todo</button>
</div><br>

<script>
document.getElementById('buscar_equipo').addEventListener('keyup', function() {
  var filter = this.value.toLowerCase();
  var labels = document.querySelectorAll('#lista_equipos label');
  labels.forEach(label => {
    var text = label.textContent.toLowerCase();
    if (text.includes(filter)) {
      label.style.display = 'block';   // 游댳 fuerza que cada label siga en su l칤nea
    } else {
      label.style.display = 'none';
    }
  });
});

// Si se marca "todos", desmarcar los dem치s autom치ticamente
document.querySelector('input[value="todos"]').addEventListener('change', function() {
  const allCheckboxes = document.querySelectorAll('#lista_equipos input[type="checkbox"]');
  if (this.checked) {
    allCheckboxes.forEach(chk => { if (chk !== this) chk.checked = false; });
  }
});
// Bot칩n para deseleccionar todo
document.getElementById('deseleccionar_todo').addEventListener('click', function() {
  const checkboxes = document.querySelectorAll('#lista_equipos input[type="checkbox"]');
  checkboxes.forEach(chk => chk.checked = false);
});
</script>

        <div>
            <label for="tipos">Tipos de Repuesto:</label><br>
            <select name="tipos" id="tipos" multiple>
                <option value="todos" {% if 'todos' in filtros.tipos %}selected{% endif %}>-- Todos los tipos --</option>
                {% for tipo in tipos_lista %}
                <option value="{{ tipo }}" {% if tipo in filtros.tipos %}selected{% endif %}>{{ tipo }}</option>
                {% endfor %}
            </select>
        </div><br>

        <div>
            <label for="fecha_inicio">Fecha inicio:</label>
            <input type="date" id="fecha_inicio" name="fecha_inicio" value="{{ filtros.fecha_inicio }}">
        </div><br>

        <div>
            <label for="fecha_fin">Fecha fin:</label>
            <input type="date" id="fecha_fin" name="fecha_fin" value="{{ filtros.fecha_fin }}">
        </div><br>

        <button type="submit">Filtrar</button>
        <button type="submit" name="exportar" value="excel">Exportar a Excel</button>
        <button type="submit" name="exportar" value="pdf">Exportar a PDF</button>
        <a href="{{ url_for('menu_reportes') }}" class="boton-volver">Volver al men칰</a>
    </form>

    <div class="total-container">
        Total de repuestos ingresados: {{ total }}
    </div>

    <table>
        <thead>
            <tr>
                <th>No. Movimiento</th>
                <th>Repuesto</th>
                <th>Cantidad</th>
                <th>Tipo</th>
                <th>Fecha de ingreso</th>
                <th>M치quina</th>
            </tr>
        </thead>
        <tbody>
            {% if datos %}
                {% for d in datos %}
                <tr>
                    <td>{{ d.movimiento }}</td>
                    <td>{{ d.repuesto }}</td>
                    <td>{{ d.cantidad }}</td>
                    <td>{{ d.tipo }}</td>
                    <td>{{ d.fecha.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>{{ d.maquina or 'Sin m치quina' }}</td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="6" style="text-align:center;">No hay datos para mostrar</td></tr>
            {% endif %}
        </tbody>
    </table>

    <div class="chart-container">
        <canvas id="graficoBarras"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Previene seleccionar "todos" y otros valores a la vez
        function manejarSeleccionMultiple(id) {
            const select = document.getElementById(id);
            select.addEventListener('change', () => {
                const options = Array.from(select.options);
                const todos = options.find(opt => opt.value === 'todos');
                if (todos.selected) {
                    options.forEach(opt => {
                        if (opt !== todos) opt.selected = false;
                    });
                } else {
                    todos.selected = false;
                }
            });
        }
        manejarSeleccionMultiple('equipos');
        manejarSeleccionMultiple('tipos');

        // Generar gr치fico
        const ctx = document.getElementById('graficoBarras').getContext('2d');
        const etiquetas = {{ etiquetas | tojson }};
        const valores = {{ valores | tojson }};

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: etiquetas,
                datasets: [{
                    label: 'Cantidad por m치quina',
                    data: valores,
                    backgroundColor: 'rgba(39, 174, 96, 0.7)',
                    borderColor: 'rgba(39, 174, 96, 1)',
                    borderWidth: 1,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        precision: 0
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    </script>
</body>
</html>
